# Maintainer: Caleb Connolly <caleb@connolly.tech>
# Co-Maintainer: Joel Selvaraj <jo@jsfamily.in>
# Stable Linux kernel with patches for SDM845 devices
# Kernel config based on: arch/arm64/configs/defconfig and sdm845.config

_flavor="postmarketos-qcom-sdm845"
pkgname=linux-$_flavor
pkgver=6.2.0_rc3
pkgrel=1
pkgdesc="Mainline Kernel fork for SDM845 devices"
arch="aarch64"
_carch="arm64"
url="https://gitlab.com/sdm845-mainline/linux"
license="GPL-2.0-only"
options="!strip !check !tracedeps
    pmb:cross-native
    pmb:kconfigcheck-community"
makedepends="bash bison findutils flex installkernel openssl-dev perl"
depends="libnetfilter_queue-dev foot gcc musl-dev linux-headers py3-blessed py3-pip coreutils xhost procps bash"

_config="config-$_flavor.$arch"
_tag="sdm845-6.2.0_rc3"

# Source
source="
    linux-$_tag.tar.gz::https://gitlab.com/sdm845-mainline/linux/-/archive/$_tag/linux-$_tag.tar.gz
    0001-snitch.patch
    $_config
"
builddir="$srcdir/linux-$_tag"

prepare() {
    default_prepare
    cp "$srcdir/config-$_flavor.$arch" .config
    cd $builddir
    if [ 0 = $(find -name snitch.c | wc -l) ]; then
        patch -s -p1 -N -i $srcdir/0001-snitch.patch # the triple paths with APKBUILD are probably causing this. only patch once
    fi
}

build() {
    unset LDFLAGS
    make ARCH="$_carch" CC="${CC:-gcc}" KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-${_flavor}-Snitch"
}

package() {
    install -Dm644 "$builddir/arch/$_carch/boot/Image.gz" \
        "$pkgdir/boot/vmlinuz"

    make modules_install dtbs_install \
        ARCH="$_carch" \
        INSTALL_PATH="$pkgdir"/boot/ \
        INSTALL_MOD_PATH="$pkgdir" \
        INSTALL_MOD_STRIP=1 \
        INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs
    rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

    install -D "$builddir"/include/config/kernel.release \
        "$pkgdir"/usr/share/kernel/$_flavor/kernel.release
}

sha512sums="
ca0d8ed416cfdd96c2d840b4f6f9492efd911baed0ec0f6557327206efbfad350be56f7727dd11c6a5c23565f29f75ee0a46efbd3bcc0c2879d19ad65acf4d76  linux-sdm845-6.2.0_rc3.tar.gz
99191e909e3c0b89229f76ea697467e6de43180983a115e678b526886ee987b5148aaaf73abb604fb0404b49dadc45c548804b40d80b05b7644eab5141d140d7  0001-snitch.patch
f8e2e244f0e3cafc6f5a3e5c0e69a5af182f0dca49e041c1719181a3b46d25db026b7db9582882902917b2ca68135b97290ccb33ddb158724e4ee00612f66c55  config-postmarketos-qcom-sdm845.aarch64
"
